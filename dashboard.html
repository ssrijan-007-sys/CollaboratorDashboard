<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Promo Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyB1wbJonjyJQDrPJWbMCVBtRolJH4HDskU",
  authDomain: "shreejee-ayucare.firebaseapp.com",
  databaseURL: "https://shreejee-ayucare-default-rtdb.firebaseio.com",
  projectId: "shreejee-ayucare",
  storageBucket: "shreejee-ayucare.firebasestorage.app",
  messagingSenderId: "247248655859",
  appId: "1:247248655859:web:b09bfc30ff6953aad42e86",
  measurementId: "G-3ZCF4H1QPP"
};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.addEventListener("DOMContentLoaded", async () => {
      let currentUser = JSON.parse(localStorage.getItem("currentCollaborator"));
      if (!currentUser || !currentUser.promoCode) {
        window.location.href = "index.html";
        return;
      }

      const userRef = ref(db, "users/" + currentUser.promoCode);
      const snap = await get(userRef);

      if (!snap.exists()) {
        currentUser.balance = 0;
        await set(userRef, {
          name: currentUser.name,
          email: currentUser.email,
          role: currentUser.role,
          promoCode: currentUser.promoCode,
          balance: currentUser.balance,
          withdrawRequest: {}
        });
      } else {
        const firebaseData = snap.val();
        currentUser = { ...currentUser, ...firebaseData, promoCode: currentUser.promoCode };
      }

      localStorage.setItem("currentCollaborator", JSON.stringify(currentUser));

      // Update header
      document.getElementById("welcomeText").textContent = `Welcome, ${currentUser.name}`;
      document.getElementById("promoCode").textContent = `Promo: ${currentUser.promoCode}`;
      const balanceBtn = document.getElementById("balanceBtn");
      balanceBtn.textContent = `Balance: ₹${currentUser.balance}`;

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("currentCollaborator");
        window.location.href = "index.html";
      });

      const modal = document.getElementById("withdrawModal");
      const modalClose = document.getElementById("closeModal");
      const withdrawForm = document.getElementById("withdrawForm");
      const withdrawInput = document.getElementById("withdrawAmount");

      const withdrawSectionBtn = document.getElementById("withdrawSectionBtn");
      const historySectionBtn = document.getElementById("historySectionBtn");
      const withdrawSection = document.getElementById("withdrawSection");
      const historySection = document.getElementById("historySection");
      const historyContainer = document.getElementById("historyContainer");

      // Switch sections
      withdrawSectionBtn.addEventListener("click", () => {
        withdrawSection.classList.remove("hidden");
        historySection.classList.add("hidden");
      });
      historySectionBtn.addEventListener("click", () => {
        withdrawSection.classList.add("hidden");
        historySection.classList.remove("hidden");
      });

      // Check withdraw status
      const checkWithdrawStatus = async () => {
        const withdrawSnap = await get(ref(db, `users/${currentUser.promoCode}/withdrawRequest`));
        let canWithdraw = true;
        if (withdrawSnap.exists() && withdrawSnap.val().status === "Pending") {
          canWithdraw = false;
        }
        return canWithdraw;
      };

      const loadHistory = async () => {
        historyContainer.innerHTML = "";
        // Fetch completed or pending withdraws
        const userSnap = await get(ref(db, "users/" + currentUser.promoCode));
        const userData = userSnap.val();
        if (userData.withdrawRequest) {
          const request = userData.withdrawRequest;
          if (request.status) {
            const row = document.createElement("div");
            row.className = "py-1 border-b border-gray-200 text-sm flex justify-between";
            const date = request.timestamp ? new Date(request.timestamp).toLocaleString() : "";
            row.innerHTML = `<span>₹${request.amount} - ${request.status}</span><span>${date}</span>`;
            historyContainer.appendChild(row);
          }
        }
      };

      balanceBtn.addEventListener("click", async () => {
        withdrawInput.value = "";
        const canWithdraw = await checkWithdrawStatus();
        if (!canWithdraw) {
          const msg = document.createElement("div");
          msg.className = "fixed top-4 right-4 bg-yellow-100 text-yellow-800 px-4 py-2 rounded shadow-lg z-50";
          msg.textContent = "Please wait until your previous request is approved.";
          document.body.appendChild(msg);
          setTimeout(() => msg.remove(), 5000);
          return;
        }
        await loadHistory();
        withdrawSection.classList.remove("hidden");
        historySection.classList.add("hidden");
        modal.classList.remove("hidden");
      });

      modalClose.addEventListener("click", () => {
        modal.classList.add("hidden");
      });

      withdrawForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const amount = parseFloat(withdrawInput.value);
        if (isNaN(amount) || amount <= 0 || amount > currentUser.balance) {
          alert("Invalid amount!");
          return;
        }

        // Create withdraw request in firebase
        await set(ref(db, `users/${currentUser.promoCode}/withdrawRequest`), {
          amount: amount,
          timestamp: Date.now(),
          status: "Pending"
        });

        modal.classList.add("hidden");

        const msg = document.createElement("div");
        msg.className = "fixed top-4 right-4 bg-blue-100 text-blue-800 px-4 py-2 rounded shadow-lg z-50";
        msg.textContent = "Withdraw request sent! Transaction may take up to 24 hours.";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 8000);
      });

      // Fetch orders
      const ordersRef = ref(db, "orders");
      const snapshotOrders = await get(ordersRef);
      const ordersContainer = document.getElementById("ordersContainer");
      ordersContainer.innerHTML = "";

      if(snapshotOrders.exists()){
        let found = false;
        snapshotOrders.forEach(orderSnap => {
          const order = orderSnap.val();
          if(order.promoCode === currentUser.promoCode){
            found = true;
            const fullName = `${order.firstName || ""} ${order.lastName || ""}`.trim();
            const fullAddress = `${order.address || ""}, ${order.city || ""}, ${order.state || ""}, ${order.pincode || ""}`;
            const status = order.status || "Pending";

            const row = document.createElement("div");
            row.className = "grid grid-cols-3 gap-4 py-3 border-b border-gray-200 text-sm";

            let statusClass = "text-gray-700 font-semibold";
            if (status === "Delivered") statusClass = "text-green-700 font-semibold";
            else if (status === "Not Delivered") statusClass = "text-red-700 font-semibold";

            row.innerHTML = `
              <div class="font-medium text-gray-800">${fullName}</div>
              <div class="text-gray-600">${fullAddress}</div>
              <div class="${statusClass}">${status}</div>
            `;
            ordersContainer.appendChild(row);
          }
        });

        if(!found) ordersContainer.innerHTML = `<p class="text-gray-500">No orders for your promo code.</p>`;
      } else {
        ordersContainer.innerHTML = `<p class="text-gray-500">No orders available.</p>`;
      }
    });
  </script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f9fafb; }
    .header { background: linear-gradient(to right, #2563eb, #3b82f6); }
    #balanceBtn { cursor: pointer; text-decoration: underline; }
    .tab-btn { cursor: pointer; padding: .25rem .5rem; border: 1px solid #ccc; border-radius: .25rem; margin-right: .5rem; font-weight: 500; }
    .tab-btn-active { background-color: #2563eb; color: white; }
  </style>
</head>
<body class="h-screen flex flex-col">

  <!-- Header -->
  <header class="header text-white p-4 flex justify-between items-center shadow-md">
    <h1 id="welcomeText" class="text-lg font-semibold">Welcome</h1>
    <div class="flex items-center gap-4">
      <span id="promoCode" class="text-md font-medium"></span>
      <button id="balanceBtn" class="text-md font-medium underline"></button>
      <button id="logoutBtn" class="px-4 py-1 bg-red-500 hover:bg-red-600 rounded text-white font-medium shadow">
        Logout
      </button>
    </div>
  </header>

  <!-- Orders -->
  <main class="flex-1 p-6">
    <h2 class="text-2xl font-bold mb-4">Your Orders</h2>
    <div id="ordersContainer" class="bg-white rounded-lg shadow p-6 text-gray-600">
      <p class="text-gray-500">Loading orders...</p>
    </div>
  </main>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg w-96 p-6 relative">
      <h3 class="text-xl font-bold mb-4">Withdraw Money</h3>
      <div class="flex mb-4">
        <button id="withdrawSectionBtn" class="tab-btn tab-btn-active">Withdraw</button>
        <button id="historySectionBtn" class="tab-btn">History</button>
      </div>
      <div id="withdrawSection" class="space-y-4">
        <form id="withdrawForm">
          <input id="withdrawAmount" type="number" min="1" placeholder="Enter amount" class="w-full border rounded-lg p-2" required/>
          <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded font-medium">Submit</button>
        </form>
      </div>
      <div id="historySection" class="space-y-2 hidden">
        <div id="historyContainer" class="max-h-64 overflow-y-auto"></div>
      </div>
      <button id="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 font-bold text-lg">✕</button>
    </div>
  </div>

</body>
</html>
